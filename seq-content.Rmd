
```{r}
# library(ruler)
library(latex2exp)


seq_con.df <- fread("data/mutyper-results/spectra/stratify/seq_content.tbl")
colnames(seq_con.df)[length(seq_con.df)] <- "stratify"



seq_summary <- seq_con.df %>%
    filter(stratify %in% c("SD", "Unique")) %>%
    group_by(stratify) %>%
    summarise(
        A = sum(`6_num_A`),
        C = sum(`7_num_C`),
        G = sum(`8_num_G`),
        T = sum(`9_num_T`)
    ) %>%
    group_by(stratify) %>%
    mutate(
        Total = (sum(A) / 1e3 + sum(T) / 1e3 + sum(G) / 1e3 + sum(C) / 1e3) * 1e3,
        GC = (sum(G) + sum(C)) / Total,
        AT = (sum(A) + sum(T)) / Total
    )

sd_targets <- fread("data/mutyper-results/spectra/stratify/SD_targets.txt")
unique_targets <- fread("data/mutyper-results/spectra/stratify/Unique_targets.txt")
targets <- bind_rows(
    list(SD = sd_targets, Unique = unique_targets),
    .id = "stratify"
)
colnames(targets)[2:3] <- c("first_three_bases", "target_count")
spectra <- fread("data/mutyper-results/tables/stratify/spectra_SD_Unique.tbl") %>%
    merge(targets, by = c("first_three_bases", "stratify")) %>%
    mutate(
        target_percent = count / target_count * 100,
        count_adj = count / target_count,
    ) %>%
    data.table()

grouped_spectra <- spectra %>%
    group_by(
        stratify, mid_base,
        spectra, first_base, last_base,
        first_three_bases, first_two_bases,
        target_count
    ) %>%
    summarise(count = sum(count), n_samples = length(unique(sample))) %>%
    mutate(
        count_adj = count / target_count,
        target_percent = 100 * (count / n_samples) * 1 / target_count,
        spectra = gsub(">.", ">", spectra),
        spectra = gsub(".$", "", spectra),
    ) %>%
    data.table()
grouped_spectra

grouped_spectra %>%
    group_by(stratify) %>%
    summarise(sum(count) / 1e6, sum(target_percent))

z <- spectra %>%
    group_by(
        stratify, mid_base,
        spectra, first_base, last_base,
        first_three_bases, first_two_bases,
        target_count
    ) %>%
    summarise(count = sum(count)) %>%
    merge(seq_summary)

spectra_table <- grouped_spectra %>%
    mutate(
        y = count_adj,
        y = target_percent,
    ) %>%
    pivot_wider(
        names_from = c("stratify"), values_from = "y",
        id_cols = c("spectra", "first_base", "mid_base", "first_three_bases"),
    ) %>%
    mutate(
        y = log2(SD / Unique),
        # y= SD/Unique,
        size = abs(SD - Unique),
        rank = rank(y),
        per = rank / max(rank),
        `# GC bases` = as.character(str_count(first_three_bases, "G|C"))
    ) %>%
    arrange(
        `# GC bases`,
        y,
        mid_base,
        spectra,
    ) %>%
    mutate(
        spectra = factor(spectra, levels = spectra)
    )

spectra_plot <- spectra_table %>%
    data.table() %>%
    ggplot(
        aes(
            x = spectra,
            y = y, label = spectra,
            color = `# GC bases`,
            # size=size,
            # size = 3,
        )
    ) + # , color = stratify)) +
    geom_point(size = 3) +
    scale_x_discrete(guide = guide_axis(n.dodge = 6)) +
    geom_text_repel(
        data = . %>% filter(per <= 0.10 | per >= 0.90),
        nudge_y = .05, # )/10,
        nudge_x = -1,
        force = 20,
        # direction = "y",
        color = "black",
        size = 3,
    ) +
    theme_minimal_grid() +
    scale_color_viridis_d(direction = -1) +
    ylab(TeX("$ log_2 \\; \\frac{N \\; corrected \\; SD \\; events}{N \\; corrected \\; unique \\; events}$")) +
    xlab("Mutation event") +
    theme(
        legend.position = "top",
        plot.margin = margin(0.1, 1, 0.1, 0.1, unit = "cm"),
    ) +
    coord_cartesian(clip = "off")
ggsave("figures/seq_comp.pdf", width = 12)
ggsave("tmp.pdf", width = 12)



sum(fread("data/mutyper-results/spectra/stratify/SD_spectra.txt")[, 2:97]) / 1e6
sum(fread("data/mutyper-results/spectra/stratify/Unique_spectra.txt")[, 2:97]) / 1e6

tmp
dim(tmp)
colnames(tmp)
```



```{r}
target_diffs <- targets %>%
    pivot_wider(
        names_from = c("stratify"), values_from = "target_count",
        id_cols = c("first_three_bases"),
    ) %>%
    mutate(
        total_sd = sum(SD),
        total_u = sum(Unique),
        fold = (SD / total_sd) / (Unique / total_u),
        log2 = log2(fold)
    ) %>%
    rowwise() %>%
    mutate(
        matrix = list(
            matrix(c(SD, Unique, total_sd - SD, total_u - Unique), nrow = 2)
        ),
        # stat_test = list(chisq.test(c(SD, Unique), c(total_sd, total_u))),
        # stat_test = fisher.test(matrix)$p.value,
        stat_test = list(chisq.test(matrix)), # $p.value,
        pval = stat_test$p.value * nrow(.),
        `# GC bases` = as.character(str_count(first_three_bases, "G|C"))
    ) %>%
    ungroup() %>%
    arrange(
        `# GC bases`,
        log2,
        first_three_bases
    ) %>%
    mutate(
        first_three_bases = factor(first_three_bases, levels = first_three_bases)
    )
target_diffs

target_plot <- ggplot(
    target_diffs,
    aes(
        x = first_three_bases,
        y = log2,
        # y = -log10(pval),
        # color = pval < 0.05,
        label = first_three_bases,
        color = `# GC bases`,
    )
) +
    geom_point(size = 3) +
    scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
    scale_color_viridis_d(direction = -1) +
    ylab(TeX("$ log_2 \\; \\frac{SD \\; 3mer \\; counts}{Unique \\; 3mer \\; counts}$")) +
    xlab("") +
    theme_minimal_grid() +
    theme(legend.position = "top")

ggsave("tmp.pdf")
```


```{r}
library(ggfortify)
library(compositions)

spectra_wide <- spectra %>%
    # filter(stratify == "Unique") %>%
    group_by(stratify) %>%
    # mutate(target_percent = count_adj) %>%
    mutate(target_percent = target_percent / sum(target_percent)) %>%
    ungroup() %>%
    merge(pop_small, by.x = "sample", by.y = "SampleID") %>%
    # filter(stratify == "Unique") %>%
    pivot_wider(id_cols = c("stratify", "sample", "Superpopulation"), names_from = c("spectra"), values_from = c("target_percent")) %>%
    data.table()
spec_mat <- spectra_wide[, 4:ncol(spectra_wide)]
spec_mat %>% as.tibble()
# normatize per row
spec_mat <- t(apply(spec_mat, 1, function(x) (x) / (sum(x))))
# log scale per will suggestion
spec_mat <- clr(spec_mat)

spectra_pca <- prcomp(spec_mat, scale. = TRUE)
sort(spectra_pca$rotation[, 1])

pca_plot <- spectra %>%
    merge(pop_small, by.x = "sample", by.y = "SampleID") %>%
    ggplot(
        aes(
            x = PC1,
            y = PC2,
            color = Superpopulation,
            # shape = stratify,
        )
    ) +
    geom_point() +
    theme_minimal_grid() +
    facet_row(~stratify, scales = "free") +
    theme(legend.position = "top")

pca_plot <- autoplot(spectra_pca,
    data = spectra_wide,
    colour = "Superpopulation",
    shape = "stratify",
    # x = 4, y = 5
) +
    scale_color_brewer("", palette = "Set1") +
    scale_shape_discrete("") +
    guides(
        color = guide_legend(nrow = 2),
        shape = guide_legend(nrow = 2)
    ) +
    theme_minimal_grid() +
    theme(
        legend.position = "top"
    )

ggsave("tmp.pdf")
```




```{r}
library(gridExtra)
tmrca <- c(
    "chrom", "start", "end", "TMRCA", "del_frac",
    "AT", "GC",
    "8_num_A", "9_num_C", "10_num_G", "11_num_T", "12_num_N",
    "13_num_oth", "14_seq_len",
    "igc_count", "igc_frac"
)
tsd <- fread("data/TMRCA/del_anno_sd.age.txt", col.names = tmrca)
tuq <- fread("data/TMRCA/del_anno_uniq.age.txt", col.names = tmrca)
time.df <- bind_rows(list(`SD` = tsd, `Unique` = tuq), .id = "Region") %>%
    filter(del_frac < 0.1) %>%
    filter(igc_frac <= 0.0) %>%
    data.table()
dim(time.df)
#time.df %>% fwrite("data/TMRCA/TMRCA.tbl", sep="\t", row.names=F)

z <- time.df %>%
    group_by(Region) %>%
    mutate(
        per = ecdf(TMRCA)(TMRCA),
        is_old = TMRCA > mean(TMRCA) + 1 * sd(TMRCA),
        is_old = per > 0.9,
        GC = GC / mean(GC)
    ) %>%
    group_by(Region, is_old) %>%
    # summarise(mean(GC), n())
    ggplot(aes(x = GC, fill = Region)) +
    scale_fill_manual(values = COLORS) +
    geom_histogram(bins = 50) +
    facet_grid(is_old ~ Region, scale = "free_y") +
    theme_minimal_grid()
ggsave("tmp.pdf")

t_sum <- time.df %>%
    #filter(chrom != "chrX") %>%
    #mutate(is_X = chrom =="chrX") %>%
    group_by(Region) %>%
    mutate(TMRCA = TMRCA / 1e6) %>%
    summarise(
        `# windows` = n(),
        # max(TMRCA),
        `mean TMRCA (myr)` = mean(TMRCA),
        `median TMRCA (myr)` = median(TMRCA)
    ) %>%
    mutate(across(where(is.numeric), round, 3)) %>%
    # mutate(across(where(is.numeric), comma))
    data.table()
t_sum

z <- time.df %>%
    ggplot(aes(x = TMRCA, color = Region)) +
    stat_ecdf(geom = "step", size = 1, alpha = 0.8) +
    scale_x_continuous("Time to most recent common ancestor (TMRCA)",
        trans = "log10", label = comma
    ) +
    ylab("Fraction of 10 kbp windows") +
    scale_color_manual("", values = COLORS[c("SD", "Unique")]) +
    theme_cowplot() +
    facet_zoom(2e5 < TMRCA & TMRCA < 4e6, zoom.size = 3) +
    annotation_logticks(sides = "b") +
    theme(legend.position = "top")

tt <- ttheme_minimal(
    base_size = 12,
    padding = unit(c(2, 2), "mm"),
    core = list(padding = unit(c(1, 1), "mm")),
)

plot.timing <- cowplot::plot_grid(
    tableGrob(t_sum, theme = tt, rows = NULL),
    z,
    rel_heights = c(1, 10), ncol = 1
)
ggsave("tmp.pdf")
plot.timing <- z

wilcox.test(
    time.df[Region == "SD"]$TMRCA,
    time.df[Region == "Unique"]$TMRCA,
    alternative =  "greater",
)


mean(time.df[Region == "SD"]$TMRCA) / mean(time.df[Region == "Unique"]$TMRCA)
```




```{r}
layout <- "
AAAABBBBBB
AAAACCCCCC
DDDDDDDDDD
DDDDDDDDDD
"
fig <- plot.timing + target_plot + pca_plot + spectra_plot + # plot.timing +
    plot_layout(design = layout) +
    plot_annotation(tag_levels = "a") & theme(plot.tag = element_text(size = 24))
scale <- 0.8
ggsave("tmp.pdf", fig, width = 16 * scale, height = 16 * scale)
ggsave("figures/full-figs/mutyper.pdf", fig, width = 16 * scale, height = 16 * scale)
```



# some stats from the figs
```{r}
t_sum

spectra_table <- data.table(spectra_table)
spectra_table[grepl(".CG>T", spectra), ] %>%
    mutate(ave = 1 - SD / Unique) %>%
    summarise(mean(ave), 1-mean(2**y) )

targets %>%
    mutate(mid_base = substr(first_three_bases, 2, 2)) %>%
    group_by(stratify) %>%
    mutate(total = sum(target_count)) %>%
    group_by(mid_base, stratify) %>%
    summarise(
        frac = sum(target_count) / total,
        total
    ) %>%
    unique()
t.test( 
    x=c(rep(1,122193647*0.424), rep(0,122193647*(1-.424))  ),
    #y=c(rep(1, 2542623043/1e4*.408), rep(0, 2542623043/1e4*(1-.408) )  ),
    mu = 0.408,
    alternative = "greater"
)
```



```{r}
spectra_table %>%
  arrange(-y) %>% 
  mutate(`Fold change`=2**y) %>%
   select(spectra,`Fold change`, SD, Unique) %>%
   openxlsx::write.xlsx(
            file = "tables/Triplet_fold_increases.xlsx",
            )

```


```{r}


t.p = grouped_spectra %>%
    group_by(stratify) %>%
    mutate(norm_target_percent = target_percent/sum(target_percent) * 100) %>%
    ungroup() %>%
    pivot_wider(id_cols=c("spectra", "first_three_bases"),names_from=stratify, values_from=norm_target_percent) %>%
    mutate(`# GC bases` = as.character(str_count(first_three_bases, "G|C"))) %>%
    arrange(-Unique) %>%
    mutate(spectra = factor(spectra, levels=unique(spectra)))

t.p.p=t.p %>%
    ggplot(aes(color=`# GC bases`, y = Unique, x=spectra) ) +
    geom_point() + 
    facet_col(~`# GC bases`)


ggsave("tmp.pdf")
```